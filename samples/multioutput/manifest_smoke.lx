// Multioutput JSON-manifest smoke with OpenAI: PNG + CSV via b64
let model = get_env_or("LEXON_MODEL", "gpt-4");
set_default_model(model);
let out_dir = get_env_or("LEXON_OUT_DIR", "output");
begin_pipeline("multioutput_manifest_smoke");

// Allow png/csv up to 2MB
set_file_output_limits(["png", "csv"], 2097152);

let system = "You will return ONLY a JSON manifest for files with base64 data, nothing else. Use standard base64 without line breaks.";
let fewshot = "Example:\n{\"files\":[{\"name\":\"example.bin\",\"mime\":\"application/octet-stream\",\"b64\":\"QUJD\"}]}";
let instructions = "Return EXACTLY this JSON shape and nothing more (no comments, no markdown):\n{\n  \"files\": [\n    {\"name\": \"chart.png\", \"mime\": \"image/png\", \"b64\": \"<BASE64 PNG>\"},\n    {\"name\": \"report.csv\", \"mime\": \"text/csv\", \"b64\": \"<BASE64 CSV>\"}\n  ]\n}\nConstraints:\n- base64 must be valid (no newlines).\n- Each b64 must decode to the declared MIME.\n- Keep both files < 200KB.\n- Output must be ONLY the JSON manifest (no prose).";

let prompt = "Create a minimalist blue 1x1 chart image and a small CSV report with two rows and two columns.";

// Ask for two outputs but we expect the JSON manifest. Runtime will parse and write the files.
let mo = ask_multioutput(system + "\n" + fewshot + "\n" + instructions + "\n" + prompt, ["chart.png", "report.csv"]);

// Save via streaming
save_multioutput_streaming_file(mo, 0, out_dir + "/mani_chart.png");
save_multioutput_streaming_file(mo, 1, out_dir + "/mani_report.csv");

let meta = get_multioutput_metadata(mo);
save_json(meta, out_dir + "/mani_meta.json");
let _ = end_pipeline();
write_metrics_json(out_dir + "/mani_metrics.json");

print("Manifest smoke completed");


