// Multioutput real-binary smoke with OpenAI: generate a PNG via base64 marker
let model = get_env_or("LEXON_MODEL", "gpt-4");
set_default_model(model);
let out_dir = get_env_or("LEXON_OUT_DIR", "output");
begin_pipeline("multioutput_real_binary");

// Allow png/json up to 1MB
set_file_output_limits(["png", "json"], 1048576);

// 1x1 transparent PNG (tiny) base64
let tiny_png = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=";

// Ask the model to respond with the marker carrying the exact base64 and a short JSON
let mo = ask_multioutput(
  "Reply with exactly this binary marker and a short JSON. Marker must be included verbatim.\n[[B64:png:" + tiny_png + "]]\nAlso include a small JSON description.",
  ["Image.png", "Desc.json"]
);

save_multioutput_streaming_file(mo, 0, out_dir + "/mo_Image.png");
save_multioutput_file(mo, 1, out_dir + "/mo_Desc.json");

let meta = get_multioutput_metadata(mo);
save_json(meta, out_dir + "/mo_real_metadata.json");
let _m = end_pipeline();
write_metrics_json(out_dir + "/mo_real_metrics.json");

print("Multioutput real-binary smoke completed");







